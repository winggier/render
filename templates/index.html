<!DOCTYPE html>
<meta charset="utf-8">

<html style="background-color:rgb(238, 230, 203);">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<!-- <h1>CG Annotation<span class = 'ano'>updated on May 10, 2022</span></h1> -->

<div class="header" id="header"></div>
<div id="table"></div>
<div id="appendix"></div>


<script>
    var text = 'grey'
    var updata = {{ data|tojson }}[0]
    audios = {{ data|tojson }}[1]
    // console.log(text)
    // header = updata[0]
    di = 3
    hd0 = ['#', 'Sentence', 'Entity', 'Entity(JA)', 'Comment']
    hd1 = ['#', 'Sentence', 'Entity', 'Entity(JA)', 'Event', 'Pragmatics', 'Comment']
    hd2 = ['#', 'Sentence', 'Entity', 'Entity(JA)', 'Event', 'Pragmatics', 'Bel(A)', 'Bel(B)', 
    'CG(A)', 'CG(B)', 'Why(CG)', 'Why in prose', 'Comment']

    hd0 = ['Sentence', 'Entity', 'Entity(JA)', '#', 'Comment']
    hd1 = ['Sentence', 'Entity', 'Entity(JA)', '#', 'Event', 'Pragmatics', 'Comment']
    hd2 = ['Sentence', 'Entity', 'Entity(JA)', '#', 'Event', 'Pragmatics', 'Bel(A)', 'Bel(B)', 
    'CG(A)', 'CG(B)', 'Why(CG)', 'Why in prose', 'Comment']

    bel = ['', 'CT+', 'CT-', 'PS']
    belc = ['→', '→CT+', '→CT-', '→PS']
    cg = ['', 'JA', 'IN','RT', 'AM']
    cgc = ['→', '→JA', '→IN', '→RT', '→AM']
    why = ['', 'WK', 'C', 'LI']


    edr = 0;                // last edited line
    max = 12;                // max line
    expand = 2;             // click expand
    pack = [];              // data pack for all dialogs
    cursor = '';            // cursor tips msg
    appp = 3;               // appendix seletion
    prvmax = 0;             // previous max
    nm = 'Annotator';       // annotator
    clips = 0;              // contain clips
    dids = [];              // did num array and index
    eja = 1;                // JA mode
    cgm = 1;                // CG mode
    hrefer = 1;             // hide default reference #
    // num_role = 0;
    // console.log(audios.includes('4092'))
    // tablet = 0;
    
    for (var i = 0; i < updata.length; i++) {
        did = updata[i].slice(0, 1)
        dialog = updata[i].slice(1)
        obj = []
        for (var j = 0; j < dialog.length; j++) {
            //ty[0] 0:mian event 1:extra
            //ty[1] #of row of sentence
            //ty[2] 1:hightlight/selected
            //ty[3] event #

            var tuple = Object.freeze({ st:dialog[j], e1:[], e2:[], er:[], ev:[], pr:[], why:[], wip:[], com:[],
                cc:[0, 0, 0, 0, 0], ccc:[0, 0, 0, 0], ty:[0, 1, 0, j+1], cc2:[[[0, 0]], [[0, 0]], [[0, 0]], [[0, 0]]], 
                eve:[[], [], [], []]})
            obj.push(tuple)
        }
        dids.push(did.toString())
        data = []
        data.push(did)
        data.push(dialog)
        data.push(obj)
        // console.log(dialog)

        pack.push(data)
    }

    // var fs = require('fs');
    // var files = fs.readdirSync('/assets/photos/');
    
    // console.log(pack[3][0])
    // console.log(pack[3][1])
    // console.log(pack[3][2])
    // var nm = prompt('User name?', 'Annotator');
    
    reload(0)
    // did = did[0]
    // console.log(did)
    // console.log(audios.includes(did[0]))


    function appendix() {
        html = `<table style='font-family:Verdana; padding:2px;'><tr style='font-weight:bold; background-color:Grey'>`;
        html += `<td style='text-align:center;'><span class='app' ph='0'>Hide</span><span class='app' ph='1'>Dialog</span>`;
        html += `<span class='app' ph='2'>Interactions</span><span class='app' ph='3'>Setting</span>`;
        // if(audios.includes(did[0])) html += `<span class='app' ph='5' style='color:darkgreen';>Audio</span>`;
        html += `<span class='app' ph='4'>What's new</span></td></tr></table>`;
        
        // html = `<table style='font-family:Verdana; padding:2px; columnWidth:100px'>`;
        // html += "<tr style='font-weight:bold; background-color:Grey'>";

        // if(!ph) hd = hd0
        // else if(ph == 1) hd = hd1
        // else hd = hd2
        // for (var i = 0; i < hd.length; i++) html += "<td style='text-align:center;'>" + hd[i] + "</td>"

        if(!appp) html = html.replace('Hide', `<span style='color:darkred'; ph='0'>Hide</span>`);
        else if(appp == 1) html = html.replace('Dialog', `<span style='color:darkred'; ph='1'>Dialog</span>`);
        else if(appp == 2) html = html.replace('Interactions', `<span style='color:darkred'; ph='2'>Interactions</span>`);
        else if(appp == 3) html = html.replace('Setting', `<span style='color:darkred'; ph='3'>Setting</span>`);
        else if(appp == 4) html = html.replace(`What's new`, `<span style='color:darkred'; ph='4'>What's new</span>`);
        else if(appp == 5) html = html.replace('Audio', `<span style='color:darkred'; ph='5'>Audio</span>`);

        // else html = html.replace(`What's new`, `<span style='color:darkred'; ph='3'>What's new</span>`);

        // Dialog
        if(appp == 1) {
            html += `<table>`

            for (var i = 0; i < dialog.length; i++) {
                html += `<tr><td style='text-align:center;'>` + (i+1) + `</td>`
                html += `<td class='info'>` + dialog[i] + `</td></tr>`;
                // if(dialog[i][0] == 'A') html += `<td class='info'>` + dialog[i] + `</td></tr>`;
                // else html += `<td class='info' style='color:darkblue'>` + dialog[i] + `</td></tr>`;
            }
            
        } 

        // Info
        else if(appp == 2) html += `<div class="info" contenteditable="true" >Click row # to select/highlight row</div><br>
            <div class="info" contenteditable="true" >Click the word in the sentences to add it to Entity
                <li>Click it again to remove it from the Entity</li>
            </div><br>

            <div class="info" contenteditable="true" >Symbols used in dialogs (Symbols will be removed when words added to Entity)
                <li>& – indicates an entity and NOT the ‘and’ conjunction; it’s how the authors of the corpus decided to mark</li>
                <li>% – expressions denoting confirmation, confusion, perhaps even rejection; those are important for us</li>
                <li>curly {} and square brackets[]– non-verbal expressions as interpreted by the authors; those would be much more
                     useful when we start listening to the audio recordings</li>
                <li>double parentheses (()) – the authors were unsure if those were the exact words of the speaker</li>
            </div><br>

            <div class="info" contenteditable="true" >Click "+" to add items to the corresponding tags
                <li>Additional events will be added in a new row under the same sentence</li>
                <li>There can be multiple entities and events under the same sentence</li>
                <li>The same event can only be associated with at most one Pragmatics, one Why in prose, and one Comment</li>
            </div><br>

            <div class="info" contenteditable="true" >Belief Tags Click Cycle:
                <li>Add events/pragmatics at next row to enable status conversion</li>
                <li>CT+ (certain belief)</li>
                <li>CT- (certain belief that not)</li>
                <li>PS (event may or may not have happened)</li>
            </div><br>

            <div class="info" contenteditable="true" >Common Ground Tags Click Cycle:
                <li>Add events/pragmatics at next row to enable status conversion</li>
                <li>JA (when an event has been just added to the CG)</li>
                <li>JA→IN</li>
                <li>JA→RT</li>
                <li>JA→AM</li>

                <li>IN (when an event already existed in the CG)</li>
                <li>IN→RT</li>
                <li>IN→AM</li>

                <li>RT (when an event has been rejected from the CG)</li>

                <li>AM (when it is impossible to determine the status)</li>
                <li>AM→IN</li>
                <li>AM→RT</li>
            </div><br>

            <div class="info" contenteditable="true" >Why Tags Click Cycle:
                <li>WK (world knowledge)</li>
                <li>C (context present in the dialog)</li>
                <li>LI (specific lexical item: word/phrase/expression)</li>
            </div>`;

        // setting
        else if(appp == 3) {
            html += `<br><table><tr><span class='sett'>Annotation table type:</span>`
            if(max < 999) html += `<span class='set' t='1' style='color:darkred'>Limited</span><span class='set' `
            else html += `<span class='set' t='1'>Limited</span><span class='set' style='color:darkred' `
            html += `t='2'>Full</span></tr></table>`;
            html += `<br><table><tr><span class='sett'>Table expand pre click:</span><span class='set' t='3'>` + expand 
            html += `</span></tr></table>`
            html += `<br><table><tr><span class='sett'>Export as:</span><span class='set' t='4'>.TSV</span></tr></table>`
            html += `<br><table><tr><span class='sett'>Entity(JA):</span><span class='set' t='5' `
            if(eja) html += `style='color:darkred'>Compact</span><span class='set' t='6'>Expand</span></tr></table>`
            else html += `>Compact</span><span class='set' t='6' style='color:darkred'>Expand</span></tr></table>`
            html += `<br><table><tr><span class='sett'>CG Mode:</span><span class='set' t='7' `
            if(cgm) html += `style='color:darkred'>Reference</span><span class='set' t='8'>Transition</span></tr></table>`
            else html += `>Reference</span><span class='set' t='8' style='color:darkred'>Transition</span></tr></table>`
            html += `<br><table><tr><span class='sett'>Default reference#</span><span class='set' t='9' `
            if(hrefer) html += `style='color:darkred'>Hide</span><span class='set' t='10'>Show</span></tr></table>`
            else html += `>Hide</span><span class='set' t='10' style='color:darkred'>Show</span></tr></table>`
        }

        // news                                                         <<<<<<<<<<<<<<<<<<<<<<<<<<
        else if(appp == 4) {
            html += `<br><div class="info" contenteditable="true" >Aug 12:`;
            html += `<li class='info'>Adds default reference # Hide and Show options</li>`;
            html += `<li class='info'>Several bug fixes and style changes</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Aug 9:`;
            html += `<li class='info'>Elements within the entity are now added to Entity(JA) on first click and 
                removed on second click</li>`;
            html += `<li class='info'>Entity(JA) tab adds Compact (default) and Expand options</li>`;
            html += `<li class='info'>Bel and CG add Reference (default) and Transition options</li>`;
            html += `<li class='info'># now indicates the event number instead of the previous line number, and 
                has been moved to the left of the event tab</li>`;
            html += `<li class='info'>Each time an event is added or removed, the corresponding # will change</li>`;
            html += `<li class='info'>Event tab in reference mode will show the reference source if the corresponding 
                event is referenced</li>`;
            html += `<li class='info'>Bel and CG in reference mode, you can add/remove/modify the reference object 
                (event number) after selected (click #)</li>`;
            html += `<li class='info'>Bel, CG and comment now have a bold border between them</li>`;
            html += `<li class='info'>Modify save and load function to support new reference and event number data, 
                and compatible with the previous transition mode data</li>`;
            html += `<li class='info'>The load function can now read files that are not the current dialog#</li>`;
            html += `<li class='info'>Custom entity input now handles the '=' symbol correctly</li>`;
            html += `<li class='info'>Bug fix for loading transition mode data</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 28:`;
            html += `<li class='info'>20 audios clips (4065 - 4495) have been added</li>`;
            html += `<li class='info'>Some audios changed from mono to stereo</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 26:`;
            html += `<li class='info'>Split audio in groups of 10 sentences</li>`;
            html += `<li class='info'>Multiple audio players may cause performance issues, especially for Safari, 
                if you encounter this problem, please try different browser such as Firefox/Chrome and let me(Wing) know</li>`;
            html += `<li class='info'>Removed the full-length audio player</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 20:`;
            html += `<li class='info'>Annotator are now displayed correctly when load file</li>`;
            html += `<li class='info'>Now each entity and + sign will be displayed on a new line</li>`;
            html += `<li class='info'>Export as .TSV added to setting</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 16:`;
            html += `<li class='info'>Dialogs with audio(#4092, #4093, #4104) now show the green audio logo below</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 15:`;
            html += `<li class='info'>Audio Playback function added to #4092</li>`;
            html += `<li class='info'>Audio Player functionality and interface depends on system and browser</li>`;
            html += `<li class='info'>Now can set the number of rows to be displayed(full or limited) and the expand 
                number</li>`;
            html += `<li class='info'>Header bugs fixed</li>`;
            html += `<li class='info'>Add remove in highlighted row‘ entity tab</li>`;
            html += `<li class='info'>Entity tab can now add custom entities</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jul 2:`;
            html += `<li class='info'>Local save and load function, there may be bugs, only for testing, 
                Can only read the job of selected dialog </li>`;
            html += `<li class='info'>Extra events bugs fix</li></div>`;

            html += `<br><div class="info" contenteditable="true" >Jun 29:`;
            html += `<li class='info'>Editing entity value bugs fix</li>`;
            html += `<li class='info'>Coloring entity in sentence</li>`;
            html += `<li class='info'>Coloring entity(JA)</li>`;
            html += `<li class='info'>Tips bug fix</li>`;
            html += `<li class='info'>Add Full dialog, updatas notes</li>`;

        }

        //audio
        else if(appp == 5) {
            // html += `<audio controls><source src="{{ url_for('static', filename='4092.mp3') }}"></audio>`
            d = "4092"
            // src = "{{ url_for('static', filename='4092.mp3') }}"
            // src = "{{ url_for('static', filename=" + d + ") }}"
            // src = "/static/4092.mp3"
            src = "/static/" + did[0] + ".mp3"
            console.log(src)
            html += `<figure><figcaption>Audio File: #` + did[0] + `</figcaption></figure><div class="audio">
                <audio id="player" width="600" height="50" 
                controls src=` + "/static/" + did[0] + ".mp3" + `>
                Your browser does not support the <code>audio</code> element.</audio></div>`
        }

        else html += ``;

        // document.getElementById("tips").innerText = `(when an event has been just added to the CG)`;

        document.getElementById("appendix").innerHTML = html;
        
        document.getElementById("appendix").querySelectorAll(".app").forEach(word => {

            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
            });
            word.addEventListener("mouseout", () => {
                p = parseInt(event.target.getAttribute("ph"))
                if(p == appp) event.target.style.color = "DarkRed";
                else if(p == 5) event.target.style.color = "darkgreen";
                else event.target.style.color = "black";
            });
            word.addEventListener("click", () => { 
                appp = parseInt(event.target.getAttribute("ph"));
                appendix()
            });
        });

        document.getElementById("appendix").querySelectorAll(".set").forEach(word => {

            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
            });
            word.addEventListener("mouseout", () => {
                t = parseInt(event.target.getAttribute("t"))
                if(t == 1 && max < 999) event.target.style.color = "DarkRed";
                else if(t == 2 && max > 999) event.target.style.color = "grey";
                else if(t == 5 && eja) event.target.style.color = "DarkRed";
                else if(t == 6 && !eja) event.target.style.color = "DarkRed";
                else if(t == 7 && cgm) event.target.style.color = "DarkRed";
                else if(t == 8 && !cgm) event.target.style.color = "DarkRed";
                else if(t == 9 && hrefer) event.target.style.color = "DarkRed";
                else if(t == 10 && !hrefer) event.target.style.color = "DarkRed";
                else event.target.style.color = "grey";
            });
            word.addEventListener("click", () => { 
                t = parseInt(event.target.getAttribute("t"))
                if(t == 1) max = prvmax;
                else if(t == 2) {
                    prvmax = max;
                    max = 1000;
                }
                else if(t == 3){
                    var input = prompt('Please input # of rows', expand);
                    if (isNaN(input) && input.length) alert("Must input numbers");
                    else expand = parseInt(input);
                    console.log(input)
                }
                // TSV
                else if(t == 4){
                    console.log("to TSV")
                    var obj = data;
                    let today = new Date().toISOString().replace('-', '').replace('-', '').slice(2, 8)
                    var filename = did + '_' + nm + '_' + today + '.tsv';
                    console.log(filename)
                    text = '';

                    for(var i in hd2){
                        text += hd2[i] + '\t';
                    }
                    text = text.substring(0, text.length - 1);
                    text += '\n';

                    for(var i in obj){
                        // st + e1 + e2
                        if(i < max) {
                            text += i + '\t' + obj[i].st + '\t';
                            for(var j in obj[i].e1) text += obj[i].e1[j] + ',';
                            text = text.substring(0, text.length - 1);
                            text += '\t';
                            for(var j in obj[i].e2) text += obj[i].e2[j] + ',';
                            text = text.substring(0, text.length - 1);
                            text += '\t';
    
                            text += obj[i].ev + '\t';
                            text += obj[i].pr + '\t';

                            text += bel[obj[i].cc[0]%bel.length];
                            if(obj[i].ccc[0]) text += belc[obj[i].ccc[0]%belc.length];
                            text += '\t';
                            text += bel[obj[i].cc[1]%bel.length];
                            if(obj[i].ccc[1]) text += belc[obj[i].ccc[1]%belc.length];
                            text += '\t';
                            text += cg[obj[i].cc[2]%cg.length];
                            if(obj[i].ccc[2]) text += cgc[obj[i].ccc[2]%cgc.length];
                            text += '\t';
                            text += cg[obj[i].cc[3]%cg.length];
                            if(obj[i].ccc[3]) text += cgc[obj[i].ccc[3]%cgc.length];
                            text += '\t';
                            text += why[obj[i].cc[4]%why.length];
                            text += '\t';

                            text += obj[i].wip + '\t';
                            text += obj[i].com + '\n';
                        }
                    }
                    // console.log(text)

                    var hiddenElement = document.createElement('a');
                    hiddenElement.href = 'data:attachment/text,' + encodeURI(text);
                    hiddenElement.target = '_blank';
                    hiddenElement.download = filename;
                    hiddenElement.click();
                }

                else if(t == 5) eja = 1;
                else if(t == 6) eja = 0;
                else if(t == 7) cgm = 1;
                else if(t == 8) cgm = 0;
                else if(t == 9) hrefer = 1;
                else if(t == 10) hrefer = 0;     
                // console.log(".set(max,prmax,expand):", max, prvmax, expand)
                appendix()
                process_table()
            });
        });

    }
        
    function reload(v, load=1) {
        di += v
        // did = updata[di].slice(0, 1)
        console.log(di, v)
        did = pack[di][0]
        dialog = updata[di].slice(1)

        prev = 0;
        next = 0;
        clips = 0;
        if(0 < di && di < (updata.length-1)) {
            prev = updata[di-1].slice(0, 1)
            next = updata[di+1].slice(0, 1)
        }
        else if(!di && updata.length >1) next = updata[di+1].slice(0, 1)
        else prev = updata[di-1].slice(0, 1)
        // console.log(prev, di, next)
        // console.log(dialog)
        // appp = 0;
        phase = 2;
        dialog = pack[di][1]
        data = pack[di][2]
        console.log("reloaded to ", did)
        if(load) {
            header(); process_table();
        }
        
    }

    function refine(line) {
        return line .replace("’s", "")
                    .replace("’ve", "")
                    .replace("’m", "")
                    .replace("’re", "")
                    .replace("’ll", "")
                    .replace("n’t", "")
                    .replace(/[^\w\s\']|_/g, "")
                    .replace(/\s+/g, " ")
        // return line.replace(/[^\w\s\']|_/g, "").replace(/\s+/g, " ")
    }

    function cp(des, sor, spl) {
        if(!sor.length) return
        des.length = 0;
        if(spl) {
            if(spl == 1) {  // string
                for(const element of sor.split(',')) des.push(element)
            } 
            else if(spl == 2) { // int
                for(const element of sor.split(',')) des.push(parseInt(element))
            }
            else if(spl == 3) { // cc2
                for(const element of sor.split('^')) {
                    cc = []
                    i = []
                    for(const item of element.split(',')) {
                        i.push(Number(item))
                        if(i.length == 2) {
                            cc.push(i);
                            i = [];
                        }
                        // console.log(item)
                        // console.log(des[i])
                        // des[i].push(parseInt(item))
                    }
                    des.push(cc)
                }

                for(const i in des) {
                    if(!des[i].length) des[i].push([0, 0])
                }
            }
            else if(spl == 4) { // eve
                for(const element of sor.split('^')) {
                    cc = []
                    i = []
                    for(const item of element.split(',')) {
                        i.push(Number(item))
                        if(i.length == 2) {
                            cc.push(i);
                            i = [];
                        }
                    }
                    des.push(cc)
                }
            }
        } 
        else des.push(sor)
    }

    function notation(type, index) {
        if(type == 0) {
            var input = prompt('Please input event', data[index].st);
            if(input) data[index].ev.push(input);
            console.log(data[index].ev)
        }
        else if(type == 1) {
            var input = prompt('Please input pragmatic', data[index].st);
            if(input) data[index].pr.push(input)
        }
        // console.log(index)
        process_table()
    }

    function parent(index) {
        if(data[index].st.length) return index
        for(var i = index; i > 0; i--) {
            if(!data[i].ty[0]) return i 
        }
        return 0
    }

    function stnm(w, line, i) {
        if(data[i].er.includes(refine(w))) 
            return `<span class="word" style='color:blue' line="${line}" li="${i}" ty="1">${w}</span>`
        return `<span class="word" line="${line}" li="${i}">${w}</span>`
    }

    function checkr(k) {
        if(k == 0) return 0;
        for (var i = 0; i < data.length; i++) {
            // console.log("checkr: ", k, i, data[i].ty[3]);
            if(data[i].ty[3] == k) return i
        }
        return -1;
    }

    function cccorr(v, t) {
        if(t < 2) type = bel;
        else type = cg;
        if(!(v%type.length)) return 1;
        else return 0;
    }

    function trim(text, mode) {
        if(mode == 1) {
            text = text.substring(0, text.length - 1);
            text += '\t';
            return text;
        }
        else if(mode == 2) {
            text = text.substring(0, text.length - 1);
            text += '\n';
            return text;
        }
        else console.log("trim 0");
    }

    function header() {
        did = pack[di][0]
        dialog = pack[di][1]
        data = pack[di][2]

        // console.log(did)

        html = `<span class='d'>#` + did + `</span><span class='tab'></span>`
        if(!phase) html +=`<span style='color:Darkred;'> Entities</span><span class='p' p='1'> Events </span>` + 
            `<span class='p' p='2'>Full</span><span class='tab'></span>@:<span class='at'>` + nm + `</span>`
        else if(phase == 1) html +=`<span class='p' p='0'> Entities</span><span style='color:Darkred;'> Events </span>` + 
            `<span class='p' p='2'>Full</span><span class='tab'></span>@:<span class='at'>` + nm + `</span>`
        else html +=`<span class='p' p='0'> Entities</span><span class='p' p='1'> Events </span>` + 
            `<span style='color:Darkred;'>Full</span><span class='tab'></span>@:<span class='at'>` + nm + `</span>`

        if(next) html += `<span class='next'>>></span>`
        html += `<span class='tab' style='float:right'>&nbsp;</span>`
        if(prev) html += `<span class='prev'><<</span>`

        // if(next) html += `<span class='next'>#` + next + `&nbsp;></span>`
        // html += `<span class='tab' style='float:right'>&nbsp;</span>`
        // if(prev) html += `<span class='prev'><&nbsp;#` + prev + `</span>`
        
        document.getElementById("header").innerHTML = html;

        document.getElementById("header").querySelectorAll(".d").forEach(word => {
            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
                // document.getElementById("tips").innerText = `"'${event.target.innerText}' is this`;
                document.getElementById("tips").innerText = `Enter dialog # and load`;
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => { 
                var input = prompt('Please input dialog#');
                var missed = 1
                if(input) {
                    for(var i = 0; i < updata.length; i++) {
                        if(updata[i].slice(0, 1) == input) {
                            missed = 0;
                            di = i;
                            console.log("reoload", i)
                            // header()
                            // process_table()
                            reload(0);
                            break;
                        }
                    }
                    if(missed) alert("# not found");
                }
            });
        });

        document.getElementById("header").querySelectorAll(".p").forEach(word => {
            word.addEventListener("mouseover", () => {
                p = parseInt(event.target.getAttribute("p"));
                event.target.style.color = "DarkRed";
                if(!p) document.getElementById("tips").innerText = `Show only entities`;
                else if(p == 1) document.getElementById("tips").innerText = `Show entities, events and pragmatics`;
                else document.getElementById("tips").innerText = `Show all tags`;
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;

            });
            word.addEventListener("click", () => { 
                phase = parseInt(event.target.getAttribute("p"));
                // console.log(phase)
                if(!phase) cursor = `Show only entities`;
                else if(phase == 1) cursor = `Show entities, events and pragmatics`;
                else cursor = `Show all tags`;
                header()
                process_table()
            });
        });

        document.getElementById("header").querySelectorAll(".aa").forEach(word => {
            word.addEventListener("mouseover", () => {event.target.style.color = "DarkRed";});
            word.addEventListener("mouseout", () => {event.target.style.color = "grey";});
            word.addEventListener("click", () => {
                var input = prompt('Annotator for current phase');
                if(input) console.log(input); 
                console.log("ano click", ano)
                header()
            });
        });

        document.getElementById("header").querySelectorAll(".prev").forEach(word => {
            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
                document.getElementById("tips").innerText = `Load previous (#${prev}) dialog file `;
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => {reload(-1);});
        });

        document.getElementById("header").querySelectorAll(".next").forEach(word => {
            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
                document.getElementById("tips").innerText = `Load next (#${next}) dialog file`;
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => {reload(1);});
        });

        document.getElementById("header").querySelectorAll(".at").forEach(word => {
            word.addEventListener("mouseover", () => {
                event.target.style.color = "DarkRed";
                document.getElementById("tips").innerText = `Edit annotator's name`;

            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => {
                var input = prompt('Annotator for current phase', nm);
                if(input) nm = input
                header()
            });
        });

    }

    // main table
    function process_table() {
        refresh = 0;
        ph = parseInt(phase)
        did = pack[di][0]
        dialog = pack[di][1]
        data = pack[di][2]
        senc = 0;
        if(audios.includes(did[0])) clips = 1;
        // console.log("clips:", clips)

        html = `<table style='font-family:Verdana; padding:2px; columnWidth:100px'>`;
        html += "<tr style='font-weight:bold; background-color:Grey'>";

        if(!ph) hd = hd0
        else if(ph == 1) hd = hd1
        else hd = hd2

        const index = hd.indexOf('Entity(JA)');
        if(index > -1 && eja) { // only splice array when item is found
            hd.splice(index, 1); // 2nd parameter means remove one item only
        }
        else if(index == -1 && !eja) hd.splice(2, 0, 'Entity(JA)');
        
        // console.log(hd2)

        for (var i = 0; i < hd.length; i++) html += "<td style='text-align:center;'>" + hd[i] + "</td>"
        html += "</tr>";

        // intro clips
        if(clips) html += audio_clips(0);

        rows = Math.min(max, data.length)
        for (var i = 0; i < rows; i++) {
            if(data[i].ty[0]) subnum += 1;
            else subnum = 1;
            // if(data[i].st[0] == 'A') html += "<tr style='background-color:blue'><td>" + i + "</td>";
            // else html += "<tr><td>" + i + "</td>";
            
            // clips
            if(!(senc%10) & clips) html += audio_clips(senc/10 +1)

            // highlight
            if(i == rows-1) html += `<tr>`;
            else {
                if(data[i].ty[2]%2) html += `<tr style='background-color:lightpink'>`;
                else html += `<tr>`;
            }


            html += stn(data[i].st, i);                 //sentance

            if(data[i].ty[0] && data[i].ty[2]%2)        // hightlight and remove in entity
                html += `<td class="remove" style='text-align:center; color:lightgrey' li="${i}">REMOVE</td>`;
            else html += `<td li="${i}" style='text-align:center;'>` + color(0, data[i].e1, 1, i) + `</td>`;      //e1
            // html += "<td>" + data[i].e2 + "</td>";      //entity2
            // if(!data[i].e1.length) html += `</td><td class="cc" ty="5" li="${i}">`
            // else html += `</td><td class="cc" ty="5" li="${i}">` + data[i].e1[data[i].cc[5]%data[i].e1.length];
            // e2
            if(!eja) html += not(4, i); 

            // #
            if(i == rows-1) html += `<td class="add" style='color:grey; font-weight: bold;' ty="5">↓</td>`;
            else {
                // current or next is extra event
                if(data[i].ty[0] || data[i+1].ty[0]) {
                    if(data[i].ty[0]) e = senc.toString() + '.' + subnum.toString();
                    else e = (senc+1).toString() + '.' + subnum.toString();
                }
                // regular #
                else e = (senc+1).toString();
                e = parseFloat(e);

                // ty3 updata
                if(e != data[i].ty[3]) {
                    
                    console.log("ty[3]", data[i].ty[3], " changed to ", e);

                    // change new ty3 in others' eve
                    for (var j = 0; j < data[i].cc2.length; j++) {
                        for (var k = 0; k < data[i].cc2[j].length; k++) {
                            ri = checkr(data[i].cc2[j][k][1]);
                            if(ri < 0) { alert('Error: Invalid event number(+ev1)'); return;}

                            for (var l = 0; l < data[ri].eve[j].length; l++) {
                                // console.log("remote1 ", ri, " eve ", data[ri].eve[j][l], " e ", e);
                                if(data[ri].eve[j][l][0] == data[i].ty[3]) {

                                    data[ri].eve[j][l][0] = e;
                                    console.log("after remote1 ", data[ri].eve[j][l]);
                                    // this change after previous line print, then reload table again
                                    // process_table()
                                    refresh = 1;
                                }
                            }
                        }
                    }

                    // change others reference(cc2) to new ty3
                    for (var j = 0; j < data[i].eve.length; j++) {
                        for (var k = 0; k < data[i].eve[j].length; k++) {
                            ri = checkr(data[i].eve[j][k][0]);
                            if(ri < 0) { alert('Error: Invalid event number(+ev2)'); return;}

                            for (var l = 0; l < data[ri].cc2[j].length; l++) {
                                // console.log("remote ", ri, " cc2 ", data[ri].cc2[j][l], " e ", e);
                                if(data[ri].cc2[j][l][1] == data[i].ty[3]) {
                                    data[ri].cc2[j][l][1] = e;
                                    refresh = 1;

                                }
                                
                            }
                        }
                    }

                    data[i].ty[3] = e;
                }
                html += `<td style='text-align:center; width:1%; font-weight:bold;' class="num" li="${i}">` + e + `</td>`;
            }
            
            
            if(ph) {
                html += not(0, i);                          //event
                html += not(1, i);                          //Pragmatics
                if(ph == 2) {                               //cc, why&wip
                    if(cgm) html += not(6, i);
                    else html += not(5, i);
                }           
            }
            html += not(3, i);                              //comment
            // html += "<td><input type='checkbox' ></td>";     //mark

            html += "</tr>";
            

            if(!data[i].ty[0]) senc++;
        }
        
        // html += `</table><p><span class="add" ty="5" >&nbsp;EXPAND</span></p>`;

        html += `</table><p><span id='i'></span><span id="tips" ty="5" ></span>
            <span><label for="in" class="foot" ty='1'>LOAD</label><input type="file" id="in"/></span>
            <span class="foot">SAVE</span></p>`;

        document.getElementById("table").innerHTML = html;
        document.getElementById("tips").innerText = cursor;
        appendix();
        if(refresh) process_table();
        // console.log("table done");

        //click functions
        document.getElementById("table").querySelectorAll(".word").forEach(word => {
            word.addEventListener("mouseover", () => {
                const t = event.target;
                const type = event.target.getAttribute("ty");
                const e = event.target.getAttribute("e");
                t.style.color = "Red";
                if(type == 1) document.getElementById("tips").innerText = `Add(JA) or Remove (${refine(t.innerText)})`;
                else if(type == 2) document.getElementById("tips").innerText = `Edit (${e})'s value`;
                else document.getElementById("tips").innerText = `+ (${refine(t.innerText)}) to entity`;
            });

            word.addEventListener("mouseout", () => { 
                const t = event.target;
                const type = event.target.getAttribute("ty");
                if(type == 1) t.style.color = "blue";
                else t.style.color = "black";
                document.getElementById("tips").innerText = ``;
                // t.style.fontWeight = "normal";
                // document.getElementById("msg").innerText = "";
            });

            word.addEventListener("click", () => { 
                const w = refine(event.target.innerText);
                const e = event.target.getAttribute("e");
                const li = event.target.getAttribute("li");
                const type = event.target.getAttribute("ty");
                const index = data[li].er.indexOf(e);
                const e2index = data[li].e2.indexOf(w);

                // console.log("click:", li, type, e, w, index, e2index);


                // modifice previous
                if(type == 2) {
                    // console.log("type == 2");
                    // console.log("Before", li, type, e, w, index)
                    // console.log(data[li].er, e, data[li].er.indexOf(e))
                    // console.log(data[li].e1, w, data[li].e1.indexOf(w))
                    
                    data[li].e1.splice(index, 1)
                    data[li].er.splice(index, 1)
                    var input = prompt('Please input new entity value');
                    if(input) data[li].e1.push(e + '=' + input)
                    else data[li].e1.push(e)
                    data[li].er.push(e)

                    console.log("Modified", li, type, e, w)
                    console.log(data[li].er)
                    console.log(data[li].e1)
                }

                // sentance click
                else {
                    // console.log("type != 2", type, index, e2index);
                    if(e2index == -1 && index > -1) {
                        console.log("in er but not in e2");
                        data[li].e2.push(w);
                    }
                    else {
                        if(data[li].er.includes(w)) {
                            data[li].e1.splice(data[li].er.indexOf(w), 1)
                            data[li].er.splice(data[li].er.indexOf(w), 1)
                            if(e2index > -1) data[li].e2.splice(e2index, 1)
                            // console.log(data[li].e1);
                            // console.log(data[li].er);
                            // console.log(data[li].e2);
                        }
                        else {
                            data[li].er.push(w)
                            var input = prompt('Please input entity value');
                            if(input) data[li].e1.push(w + '=' + input)
                            else data[li].e1.push(w)
                            // console.log(data[li].e1);
                            // console.log(data[li].er);
                            // console.log(data[li].e2);
                        } 
                    }

                }
                // console.log("Af click:", li, type, e, w, index, e2index);
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".cc").forEach(word => {
            // const tar = event.target;
            word.addEventListener("mouseover", () => {
                const ty = event.target.getAttribute("ty");
                const w = event.target.outerText;
                if(ty < 2) {
                    if(!w) document.getElementById("tips").innerText = `Edit Believe value (null)`;
                    else if(w == 'CT+') document.getElementById("tips").innerText = `(certain belief)`;
                    else if(w == 'CT-') document.getElementById("tips").innerText = `(certain belief that not)`;
                    else document.getElementById("tips").innerText = `(event may or may not have happened)`;

                }
                else if(ty < 4) {
                    if(!w) document.getElementById("tips").innerText = `Edit Common Ground value (null)`;
                    else if(w == 'JA') document.getElementById("tips").innerText = `(when an event has been just added to the CG)`;
                    else if(w == 'IN') document.getElementById("tips").innerText = `(when an event already existed in the CG)`;
                    else if(w == 'RT') document.getElementById("tips").innerText = `(when an event has been rejected from the CG)`;
                    else document.getElementById("tips").innerText = `(when it is impossible to determine the status)`;
                }
                else {
                    if(!w) document.getElementById("tips").innerText = `Edit why value (null)`;
                    else if(w == 'WK') document.getElementById("tips").innerText = `(world knowledge)`;
                    else if(w == 'C') document.getElementById("tips").innerText = `(context present in the dialog)`;
                    else document.getElementById("tips").innerText = `(specific lexical item (word, phrase, expression))`;
                }
                event.target.style.color = "Red";
            });
            word.addEventListener("mouseout", () => {
                const w = event.target.outerText
                // console.log(event.target.outerText)
                if(w == 'JA') event.target.style.color = "Green";
                else if(w == 'RT') event.target.style.color = "Red";
                else if(w == 'IN') event.target.style.color = "Blue";
                else  event.target.style.color = "black";
                document.getElementById("tips").innerText = ``;
            });
            // word.addEventListener("mouseover", () => {event.target.style.backgroundColor = "lightgrey";});
            // word.addEventListener("mouseout", () => {
            //     const li = event.target.getAttribute("li");
            //     if(li%2) event.target.style.backgroundColor = "rgb(238, 230, 203)";
            //     else event.target.style.backgroundColor = "#dddddd";
            // });
            word.addEventListener("click", () => { 
                // console.log("cc click")
                const type = event.target.getAttribute("ty");
                const li = event.target.getAttribute("li");
                const cgi = parseInt(event.target.getAttribute("cgi"));

                // console.log(li, type, cg, data[li].cc2[cgi][0])
                if(cgm) {
                    // console.log("ty,li,cg", type, li, cgi);
                    if(type == 4) {
                        data[li].cc[type] += 1;
                        const w = why[data[li].cc[type]%why.length];
                        if(!w) cursor = `Edit why value (null)`;
                        else if(w == 'WK') cursor = `(world knowledge)`;
                        else if(w == 'C') cursor = `(context present in the dialog)`;
                        else cursor = `(specific lexical item (word, phrase, expression))`;
                    }

                    else {
                        data[li].cc2[type][cgi][0] += 1;
                        if(cgi) data[li].cc2[type][cgi][0] += cccorr(data[li].cc2[type][cgi][0], type);
                        if(type < 2) {
                            const w = bel[data[li].cc2[type][cgi][0]%bel.length];
                            // console.log("crs:", w, data[li].cc2[type][cg][0]);
                            if(!w) cursor = `Edit Believe value (null)`;
                            else if(w == 'CT+') cursor = `(certain belief)`;
                            else if(w == 'CT-') cursor = `(certain belief that not)`;
                            else cursor = `(event may or may not have happened)`;
                        }
                        else {
                            const w = cg[data[li].cc2[type][cgi][0]%cg.length];
                            console.log("crs:", w, data[li].cc2[type][cgi][0]);
                            if(!w) cursor = `Edit Common Ground value (null)`;
                            else if(w == 'JA') cursor = `(when an event has been just added to the CG)`;
                            else if(w == 'IN') cursor = `(when an event already existed in the CG)`;
                            else if(w == 'RT') cursor = `(when an event has been rejected from the CG)`;
                            else cursor = `(when it is impossible to determine the status)`;
                        }


                        if(data[li].cc2[type][cgi][1]) {
                            ri = checkr(data[li].cc2[type][cgi][1])
                            if(ri < 0) { alert('Error: Invalid event number(cc)'); return;}
                            // console.log(ri, data[ri].eve[type])
                            for(var j = 0; j < data[ri].eve[type].length; j++) {
                                if(data[ri].eve[type][j][0] == data[li].ty[3]) data[ri].eve[type][j][1] += 1;
                                if(cgi) data[ri].eve[type][j][1] += cccorr( data[ri].eve[type][j][1], type);
                            }
                        }
                    }
                }
                else {
                    data[li].cc[type] += 1;
                    if(type < 2) {
                        const w = bel[data[li].cc[type]];
                        if(!w) cursor = `Edit Believe value (null)`;
                        else if(w == 'CT+') cursor = `(certain belief)`;
                        else if(w == 'CT-') cursor = `(certain belief that not)`;
                        else cursor = `(event may or may not have happened)`;
                    }
                    else if(type < 4) {
                        const w = cg[data[li].cc[type]];
                        if(!w) cursor = `Edit Common Ground value (null)`;
                        else if(w == 'JA') cursor = `(when an event has been just added to the CG)`;
                        else if(w == 'IN') cursor = `(when an event already existed in the CG)`;
                        else if(w == 'RT') cursor = `(when an event has been rejected from the CG)`;
                        else cursor = `(when it is impossible to determine the status)`;
                    }
                    else {
                        const w = why[data[li].cc[type]];
                        if(!w) cursor = `Edit why value (null)`;
                        else if(w == 'WK') cursor = `(world knowledge)`;
                        else if(w == 'C') cursor = `(context present in the dialog)`;
                        else cursor = `(specific lexical item (word, phrase, expression))`;
                    }
                }

                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".ccc").forEach(word => {
            word.addEventListener("mouseover", () => {
                document.getElementById("tips").innerText = `New status`;
                event.target.style.color = "Red";
            });
            word.addEventListener("mouseout", () => {
                document.getElementById("tips").innerText = ``;
                const w = event.target.outerText
                // console.log(event.target.outerText)
                if(w == 'JA') event.target.style.color = "Green";
                else if(w == 'RT') event.target.style.color = "Red";
                else if(w == 'IN') event.target.style.color = "Blue";
                else  event.target.style.color = "black";
            });
            word.addEventListener("click", () => { 
                console.log("ccc click")
                const type = event.target.getAttribute("ty");
                const li = event.target.getAttribute("li");
                data[li].ccc[type] += 1;
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".ccc0").forEach(word => {
            word.addEventListener("mouseover", () => {
                document.getElementById("tips").innerText = `Status conversion`;
                event.target.style.color = "Red";
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "lightgrey";
                document.getElementById("tips").innerText = ``
            });
            word.addEventListener("click", () => { 
                console.log("ccc click")
                const type = event.target.getAttribute("ty");
                const li = event.target.getAttribute("li");
                data[li].ccc[type] += 1;
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".add").forEach(word => {
            word.addEventListener("mouseover", () => {
                const type = event.target.getAttribute("ty");
                if(type == 0) document.getElementById("tips").innerText = `+ Event`;
                else if(type == 1) document.getElementById("tips").innerText = `+ Pragmatic`;
                else if(type == 2) document.getElementById("tips").innerText = `+ Why in prose`;
                else if(type == 3) document.getElementById("tips").innerText = `+ Comments or remarks`;
                else if(type == 4) document.getElementById("tips").innerText = `+ Entity(JA)`;
                else if(type == 5) document.getElementById("tips").innerText = `Expand (${expand}) row(s)`;
                else if(type == 6) document.getElementById("tips").innerText = `+ Customized entity(IN)`;

                event.target.style.color = "Red";

            });
            word.addEventListener("mouseout", () => {
                const type = event.target.getAttribute("ty");
                document.getElementById("tips").innerText = ``;
                if(type == 5) event.target.style.color = "grey";
                else event.target.style.color = "lightgrey";
            });
            word.addEventListener("click", () => { 
                const line = event.target.getAttribute("line");
                const type = event.target.getAttribute("ty");
                const li = parseInt(event.target.getAttribute("li"));
                // console.log(li)
                if(type == 0) {
                    var input = prompt('Please input event', line.substring(3));

                    if(!data[li].ev.length) {
                        if(input) data[li].ev.push(input);
                        // console.log(data[li].ev)
                    }
                    else {
                        if(input) {
                            // console.log(li)
                            data[parent(li)].ty[1] += 1;
                            max += 1;
                            // k = data[parent(li)].ty[3]
                            var tuple = Object.freeze({ st:'', e1:[], e2:[], er:[], ev:[input], pr:[], why:[], wip:[], 
                                com:[], cc:[0, 0, 0, 0, 0], ccc:[0, 0, 0, 0], ty:[1, li, 0, 0],  
                                cc2:[[[0, 0]], [[0, 0]], [[0, 0]], [[0, 0]]], eve:[[], [], [], []]})
                            // data.splice(parseInt(li) + 1, 0, tuple);
                            data.splice(li+1, 0, tuple);
                        }
                    }
                    edr = li;
                    // console.log("parent", parent(li), "parent size:", data[parent(li)].ty[1])
                }

                if(type == 1) {
                    edr = li;
                    var input = prompt('Please input Pragmatics', line.substring(3));
                    if(input) data[li].pr.push(input);
                }

                if(type == 2) {
                    var input = prompt('Please input Why in prose');
                    if(input) data[li].wip.push(input);
                }

                if(type == 3) {
                    var input = prompt('Comments?');
                    if(input) data[li].com.push(input);
                }
                if(type == 4) {
                    var input = prompt('Please input Entity(JA)', data[li].e1[0]);
                    if(input) {
                        if(input.includes('=')) {
                            k = input.indexOf('=');
                            w = input.substring(0, k);
                            data[li].e2.push(data[li].er[data[li].er.indexOf(w)]);
                            // data[li].er.push(input.substring(0, k))
                        }
                        else {
                            k = data[li].er.indexOf(input);
                            if(k == -1) alert("entity not found!")
                            else data[li].e2.push(data[li].er[k]);
                        }

                    }
                    
                    // data[li].e2.push(input);
                }
                if(type == 5) max += expand;
                if(type == 6) {
                    // console.log("+ customized e1");
                    var input = prompt('Please input entity');
                    if(input) {
                        if(input.includes('=')) {
                            k = input.indexOf('=');
                            // e = input.substring(0, k)
                            // rest = input.substring(k+1)
                            data[li].e1.push(input)
                            data[li].er.push(input.substring(0, k))
                        }

                        else {
                            var input2 = prompt('Please input entity value');
                            if(input2) data[li].e1.push(input + '=' + input2)
                            else data[li].e1.push(input)
                            data[li].er.push(input)
                        }

                        console.log(data[li].er)
                        console.log(data[li].e1)

                    } 
                }

                if(type == 7) {
                    const ct = event.target.getAttribute("ct"); // cc type
                    data[li].cc2[ct].push([1, 0]);
                    console.log("adding cc2", data[li].cc2);
                }

                if(type == 8) {
                    const ct = event.target.getAttribute("ct"); // cc type
                    const cgi = event.target.getAttribute("cgi"); // cc item index
                    if(data[li].cc2[ct][cgi][1] != data[li].ty[3]) {
                        // console.log("remove != ty3");
                        ri = checkr(data[li].cc2[ct][cgi][1]);
                        if(ri > -1) {
                            // console.log("ri ", ri, data[ri].eve[ct], data[li].cc2[ct][cgi]);
                            for(var j = 0; j < data[ri].eve[ct].length; j++) {
                                if(data[ri].eve[ct][j][0] == data[li].ty[3]) {
                                    console.log("j ", j, data[ri].eve[ct], data[li].ty[3]);
                                    data[ri].eve[ct].splice(j, 1)

                                }
                            }
                        }

                    }
                    data[li].cc2[ct].splice(cgi, 1)
                    // console.log("removed from cc2", data[li].cc2);
                }

                // console.log(data)
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".edits").forEach(word => {
            word.addEventListener("mouseover", () => {
                document.getElementById("tips").innerText = `Edit current value`;
                event.target.style.color = "Red";
            });
            word.addEventListener("mouseout", () => {
                const type = event.target.getAttribute("ty");
                document.getElementById("tips").innerText = ``;
                if(type == 4) event.target.style.color = "green";
                else event.target.style.color = "black";
            });
            word.addEventListener("click", () => { 
                const type = event.target.getAttribute("ty");
                const li = event.target.getAttribute("li");
                const ct = event.target.getAttribute("ct"); // cc type
                const cgi = event.target.getAttribute("cgi"); // cc item index

                var input = prompt('Please input new value', event.target.innerText);

                if(type == 0) {
                    if(input) data[li].ev.splice(0, 1, input);
                    else data[li].ev.splice(0, 1)
                }
                if(type == 1) {
                    if(input) data[li].pr.splice(0, 1, input);
                    else data[li].pr.splice(0, 1)
                }
                if(type == 2) {
                    if(input) data[li].wip.splice(0, 1, input);
                    else data[li].wip.splice(0, 1)
                }
                if(type == 3) {
                    if(input) data[li].com.splice(0, 1, input);
                    else data[li].com.splice(0, 1)
                }
                if(type == 4) {
                    console.log("Not edit at e2 anymore");
                    
                    // var input = prompt('Please input Entity(JA)', data[li].e1[0]);

                    // if(input) {
                    //     if(input.includes('=')) {
                    //         k = input.indexOf('=');
                    //         w = input.substring(0, k);
                    //         console.log("edit:", k, w);
                    //         data[li].e2.splice(0, 1, data[li].er[data[li].er.indexOf(w)]);
                    //         // data[li].er.push(input.substring(0, k))
                    //     }
                    //     else {
                    //         k = data[li].er.indexOf(input);
                    //         if(k == -1) alert("entity not found!")
                    //         else data[li].e2.splice(0, 1, data[li].er[k]);
                    //     }

                    // }
                    // else data[li].e2.splice(0, 1);

                    // if(input) data[li].e2.splice(0, 1, input);
                    // else data[li].e2.splice(0, 1)
                }
                if(type == 5) {
                    // console.log("edit refer#");
                    if(input) {
                        k = parseFloat(input);
                        ri = checkr(k);
                        // console.log(k, ri);
                        if(ri > -1) {   // valid reference number
                            if(ri >= li) { alert('Error: Event number must lees than current line(ed1)'); return;}

                            // input != original value
                            if(k != data[li].cc2[ct][cgi][1]) {
                                ori = checkr(data[li].cc2[ct][cgi][1]);
                                if(ori < 0) { alert('Error: Invalid original reference# (ed3)'); return;}

                                console.log("Updata: ", data[li].cc2[ct][cgi][1], " to ", k)
                                console.log("ori: ", data[ori].eve[ct]);
                                // console.log("1:", data[0].eve);

                                // change the original referencing eve(remove it)
                                // if multiple cc2 item point to same ty3, all removed**
                                for(var j = 0; j < data[ori].eve[ct].length; j++) {
                                    // console.log("ck: ", data[ori].eve[ct][j][0], data[li].cc2[ct][cgi][1])
                                    if(data[ori].eve[ct][j][0] == data[li].ty[3] && data[li].cc2[ct][cgi][1]) {
                                        // console.log("removed: ", data[ori].eve[ct][j][0], data[li].cc2[ct][cgi][1])
                                        data[ori].eve[ct].splice(j, 1);
                                    }
                                }
                                if(k == data[li].ty[3]) data[li].cc2[ct][cgi][1] = 0;
                                else data[li].cc2[ct][cgi][1] = k;

                                // add eve to new
                                if(k) data[ri].eve[ct].push([data[li].ty[3], data[li].cc2[ct][cgi][0]])
                                console.log("org:", event.target.innerText, "referece# to ", k, data[ri].eve[ct]);
                            }
                        }
                        else { alert('Error: Invalid event number(ed2)'); return;}
                    }

                }
                // console.log("1+:", data[0].eve);

                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".num").forEach(word => {
            word.addEventListener("mouseover", () => {
                event.target.style.color = "Red";
                document.getElementById("tips").innerText = `Highlight current row`;

            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => { 
                const li = event.target.getAttribute("li");
                data[li].ty[2] += 1;
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".remove").forEach(word => {
            word.addEventListener("mouseover", () => {
                document.getElementById("tips").innerText = `Remove current row(extra event row)`;
                event.target.style.color = "Red";
            });
            word.addEventListener("mouseout", () => {
                document.getElementById("tips").innerText = ``;
                event.target.style.color = "lightgrey";
            });
            word.addEventListener("click", () => { 
                const li = parseInt(event.target.getAttribute("li"));
                console.log("remove click", li);
                data[parent(li)].ty[1] -= 1;
                d = data[li];

                // remove cc2 links
                for (var j = 0; j < d.cc2.length; j++) {
                    for (var k = 0; k < d.cc2[j].length; k++) {
                        ri = checkr(d.cc2[j][k][1]);
                        if(ri < 0) { alert('Error: Invalid event number(rm1)'); return;}

                        for (var l = 0; l < data[ri].eve[j].length; l++) {
                            // console.log("remote1 ", ri, " eve ", data[ri].eve[j][l], " e ", e);
                            if(data[ri].eve[j][l][0] == d.ty[3]) {
                                data[ri].eve[j].splice(l, 1);
                                
                            }
                        }
                    }
                }

                // remove eve links
                for (var j = 0; j < d.eve.length; j++) {
                    for (var k = 0; k < d.eve[j].length; k++) {
                        ri = checkr(d.eve[j][k][0]);
                        if(ri < 0) { alert('Error: Invalid event number(rm2)'); return;}

                        for (var l = 0; l < data[ri].cc2[j].length; l++) {
                            // console.log("remote ", ri, " cc2 ", data[ri].cc2[j][l], " e ", e);
                            if(data[ri].cc2[j][l][1] == d.ty[3]) {
                                data[ri].cc2[j].splice(l, 1);
                                if(!(data[ri].cc2[j].length)) data[ri].cc2[j].push([0, 0])
                            }
                        }
                    }
                }                



                data.splice(li, 1)
                process_table()
            });
        });

        document.getElementById("table").querySelectorAll(".foot").forEach(word => {
            word.addEventListener("mouseover", () => {
                const ty = parseInt(event.target.getAttribute("ty"));
                if(ty) document.getElementById("tips").innerText = `Upload/import job`;
                else document.getElementById("tips").innerText = `Save current job to local`;
                event.target.style.color = "DarkRed";
            });
            word.addEventListener("mouseout", () => {
                event.target.style.color = "grey";
                document.getElementById("tips").innerText = ``;
            });
            word.addEventListener("click", () => { 
                const ty = parseInt(event.target.getAttribute("ty"));
                console.log("foot click = ", ty);
                if(!ty) save()
                // if(ty) read()
                // else save()
            });
        });

        // load
        document.querySelector("#in").addEventListener('change', function() {
            var all_files = this.files;
            if(all_files.length == 0) { alert('Error : No file selected'); return;}

            // first file selected by user
            var file = all_files[0];

            // Max 2 MB allowed
            if(file.size > 2*1024*1024) { alert('Error : Exceeded size 2MB'); return;}
            var reader = new FileReader();

            // file reading finished successfully
            reader.addEventListener('load', function(e) {

                // var dd = e.target.file;
                console.log(file.name)
                k = file.name.indexOf('_')
                if(k < 0) { alert('Error : Wrong File Name'); return;}

                
                load_did = file.name.substring(0, k);
                v = dids.indexOf(load_did) - dids.indexOf(did[0]);;
                console.log("Did:", did[0], load_did, v);
                reload(v, 0);
                
                rest = file.name.substring(k+1);
                k = rest.indexOf('_');
                if(k < 0) { alert('Error : Wrong File Name#2'); return;}
                nm = rest.substring(0, k);
                // nm = file.name.substring(k,)
                // console.log(did, nm);                

                var text = e.target.result;
                text = text.split('\n');
                // console.log("read:", text);

                line = text[0].split(',');
                // console.log(line)
                if(line.length == 1) cgm = 0;
                else cgm = 1;
                if(cgm) text.splice(0, 1);
                // console.log(text)

                // Referencing
                if(cgm) {
                    max = parseInt(line[0]);
                    eja = parseInt(line[1]);
                    cgm = parseInt(line[2]);
                    hrefer = parseInt(line[3]);

                    for(i in text) {
                        line = text[i].split('\t');
                        if(i == max) break;
                        replace = 1;

                        var tuple = Object({ st:'', e1:[], e2:[], er:[], ev:[], pr:[], why:[], wip:[], 
                                com:[], cc:[0, 0, 0, 0, 0], ccc:[0, 0, 0, 0], ty:[0, 0, 0, 0],  
                                cc2:[[], [], [], []], eve:[[], [], [], []]})

                        // extra event?
                        if(data[i].st != line[0]) {
                            console.log("Dialog != ", i, data[i].st, line[0])
                            replace = 0;
                        }

                        // main event
                        else tuple.st = data[i].st;

                        data.splice(i, replace, tuple);
                        // console.log(line);
                        // console.log(data[i])
                        cp(data[i].e1,  line[1], 1)
                        cp(data[i].e2,  line[2], 0)
                        cp(data[i].er,  line[3], 1)
                        cp(data[i].ev,  line[4], 0)
                        cp(data[i].pr,  line[5], 0)
                        cp(data[i].why, line[6], 0)
                        cp(data[i].wip, line[7], 0)
                        cp(data[i].com, line[8], 0)
                        cp(data[i].cc,  line[9], 2)
                        cp(data[i].ccc, line[10], 2)
                        cp(data[i].ty,  line[11], 2)

                        cp(data[i].cc2, line[12], 3)
                        cp(data[i].eve, line[13], 4)


                        // console.log(line);
                        // console.log(data[i]);

                    }

                    console.log("load done");


                }

                // Transition
                else {
                    max = parseInt(text[0]);
                    console.log(max, text[0])
                    edr = max;
                    cgm = 0;
                    s = text.length -1;
                    if((s-1)/12 != max && !cgm) console.log("wrong file size(!cgm)", s, (s-1)%12, max);
                    else console.log("size okay", s, max);
    
    
                    // line = 1
                    for(var i = 0; i < max; i++) {
                        if(data[i].st != text[i*12+1]) {
                            console.log("!= to data[i]", data[i].st, text[i*12+1])
                            if(text[i*12+1].length) {alert('Error : Bad dialogs'); return;}
                            var tuple = Object.freeze({ st:'', e1:[], e2:[], er:[], ev:[], pr:[], why:[], wip:[], 
                                com:[], cc:[0, 0, 0, 0, 0], ccc:[0, 0, 0, 0], ty:[0, 0, 0, 0], 
                                cc2:[[[0, 0]], [[0, 0]], [[0, 0]], [[0, 0]]], eve:[[], [], [], []]})
                                // data.splice(parseInt(li) + 1, 0, tuple);
                            data.splice(i, 0, tuple);
                            
                        }
    
                        // else console.log("st check equal")
                        // data[i].e1.length = 0;
                        // for (const element of text[i*12+2].split(',')) data[i].e1.push(element)
                        
                        cp(data[i].e1, text[i*12 +2], 1)
                        cp(data[i].e2, text[i*12 +3], 0)
                        cp(data[i].er, text[i*12 +4], 1)
                        cp(data[i].ev, text[i*12 +5], 0)
                        cp(data[i].pr, text[i*12 +6], 0)
                        cp(data[i].why, text[i*12 +7], 0)
                        cp(data[i].wip, text[i*12 +8], 0)
                        cp(data[i].com, text[i*12 +9], 0)
                        cp(data[i].cc, text[i*12 +10], 2)
                        cp(data[i].ccc, text[i*12 +11], 2)
                        cp(data[i].ty, text[i*12 +12], 2)
    
                        // console.log("ty", data[i].ty)
    
                    }
                }

                header()
                process_table()

            });

            // file reading failed
            reader.addEventListener('error', function() { alert('Error : Failed to read file');});

            // read as text file
            reader.readAsText(file);
        });

    }


    function stn(line, i) {
        // console.log(data[i].ty)
        // return `<td style='padding:4px;' class="text">` 
        //     + line.split(" ").map(word => 
        //         `<span class="word" line="${line}" li="${i}">${word}</span>`).join(" ") + `</td>`
        
        if(!phase) w = 45
        else if(phase == 1) w = 30
        else w = 18

        if(!data[i].ty[0]) 
            return `<td rowspan="` + data[i].ty[1] + `" style='padding:4px; width:` + w + `%' class="text">` 
                + line.split(" ").map(word => stnm(word, line, i)).join(" ") + `</td>`
            
        else return ``

    }

    // table notions
    function not(type, i) {
        if(!phase) w = 45
        else if(phase == 1) w = 30
        else w = 18
        var line = data[i].st
        var d = data[i]
        var dc2 = data[i].cc2

        if(type == 0) {
            html = ``;
            // main empty event
            if(!data[i].ev.length) 
                // html += `<td style='width:` + w + `%' class="add" line="${line}" li="${i}" ty="${type}">+`
                html += `<td style='width:` + w + `%; text-align: center;'><span class="add" line="${line}" 
                    li="${i}" ty="${type}" >+</span>`

            // last row
            else if((data[parent(i)].ty[1] -1) + parent(i) == i) {
                // console.log("last row", data[parent(i)].ty[1], parent(i), i)
                html += `<td><span class="edits" li="${i}" ty="${type}">` + data[i].ev[0] + `</span>
                    <span class="add" line="${line}" li="${i}" ty="${type}" style='float: right;'>+</span>`
            }

            else html += `<td><span class="edits" li="${i}" ty="${type}">` + data[i].ev[0] +`</span>`;

            // cc links
            if(cgm) {
                for(var j = 0; j < 4; j++) { // cc slot
                    if(d.eve[j].length) {
                        // console.log("not1_eve: ", i, j, d.eve[j])

                        // slot name
                        html += `<br><span class="clinks">` + hd2[j+6-eja] + `:</span>`
                        rs = ``

                        // current cc
                        for(var k = 0; k < dc2[j].length; k++) {
                            ci = dc2[j][k][0]
                            if(!dc2[j][k][1]) { // find self value in dc2[slot]
                                if(j < 2) rs += bel[ci%bel.length];
                                else rs += cg[ci%cg.length];
                                break;
                            }
                        }
                        html += `<span class="clinks">` + rs + `</span>`
                        
                        // referencing cc
                        for(var k = 0; k < d.eve[j].length; k++) {
                            ci = d.eve[j][k][1]
                            rs = `` + d.eve[j][k][0] + `:`
                            if(j < 2) rs += bel[ci%bel.length]
                            else rs += cg[ci%cg.length];
                            // rs += `(` + d.eve[j][k][0] + `)`
                            html += `<span class="clinks">` + rs + `</span>`
                        }
                    }
                }

            } 

            return html + `</td>`;

        }

        if(type == 1) {
            if(!data[i].pr.length) {
                return `<td class="add" line="${line}" li="${i}" ty="${type}">+</td>`
            }
            else {
                return `<td class="edits" li="${i}" ty="${type}">` + data[i].pr[0] + `</td>`
            }
        }

        if(type == 2) {
            if(!data[i].wip.length) {
                return `<td style='border-right:5px solid lightgrey;' class="add" line="${line}" li="${i}" ty="${type}">+</td>`
            }
            else {
                return `<td style='border-right:5px solid lightgrey;' class="edits" li="${i}" ty="${type}">` + 
                    data[i].wip[0] + `</td>`
            }
        }

        if(type == 3) {
            if(!data[i].com.length) {
                return `<td class="add" line="${line}" li="${i}" ty="${type}">+</td>`
            }
            else {
                return `<td class="edits" li="${i}" ty="${type}">` + data[i].com[0] + `</td>`
            }
        }

        if(type == 4) {
            // console.log("in not4");
            html = `<td style='text-align:center; color:green'>`;
            v = data[i].e2;
            for(var e2i = 0; e2i < v.length; e2i++) {
                html += `<span>` + v[e2i] + `</span><br>`
            }
            html += `</td>`;
            return html;



            // if(!data[i].e2.length) {
            //     return `<td class="add" line="${line}" li="${i}" ty="${type}">+</td>`
            // }
            // else {
            //     html = `<td>`;
            //     v = data[i].e2;
            //     for(var e2i = 0; e2i < v.length; e2i++) {
            //         html += `<span style='text-align:center; color:green' li="${i}" ty="${type}">`
            //             + v[e2i]
            //     }
            //     return `<td class="edits" style='text-align:center; color:green' li="${i}" ty="${type}">` +
            //         data[i].e2[0] + `</td>`
            // }
        }
        
        if(type == 5) {
            html = ``;
            // console.log("notation type 5")

            // believe
            for(var j in '12') {
                // first null
                if(!bel[data[i].cc[j]%bel.length].length) html += `<td class="cc" ty="${j}" li="${i}"><span>`;
                        
                // first present
                else {
                    // avoid same value
                    if(data[i].cc[j]%bel.length == data[i].ccc[j]%belc.length) data[i].ccc[j] += 1;
    
                    // 2nd null
                    if(!(data[i].ccc[j]%belc.length)) {
                        html += `<td style='text-align:center;'><span class="cc" ty="${j}" li="${i}" >` +
                            bel[data[i].cc[j]%bel.length] + `</span>`
                        if(edr > i) html += 
                            `<span class="ccc0" ty="${j}" li="${i}" > ` + belc[0] + `</span>`;
                        // console.log("CCC0")
                    }
    
                    // 2nd present
                    else {
                        html += `<td style='text-align:center;'><span class="cc" ty="${j}" li="${i}" >` +
                            bel[data[i].cc[j]%bel.length] + `</span><span class="ccc" ty="${j}" li="${i}" > ` +
                            belc[data[i].ccc[j]%belc.length] + `</span>`;  
                    }
                }
            }

            // CG
            for(var j in '34') {
                raw = ``
                j = parseInt(j) + 2;
                // console.log(j)
                // first null
                if(!cg[data[i].cc[j]%cg.length].length) raw += `<td class="cc" ty="${j}" li="${i}"><span>`;
                        
                // first present
                else {
                    // avoid same value
                    if(data[i].cc[j]%cg.length == data[i].ccc[j]%cgc.length) data[i].ccc[j] += 1;
    
                    // 2nd null
                    if(!(data[i].ccc[j]%cgc.length)) {
                        raw += `<td style='text-align:center;'><span class="cc" ty="${j}" li="${i}" >` +
                            cg[data[i].cc[j]%cg.length] + `</span>`
                        if(edr > i) raw += `<span class="ccc0" ty="${j}" li="${i}" > ` + cgc[0] + `</span>`;
                        // console.log("CCC0")
                    }
    
                    // 2nd present
                    else {
                        raw += `<td style='text-align:center;'><span class="cc" ty="${j}" li="${i}" >` +
                            cg[data[i].cc[j]%cg.length] + `</span><span class="ccc" ty="${j}" li="${i}" > ` +
                            cgc[data[i].ccc[j]%cgc.length] + `</span>`;  
                    }

                }

                html += color(1, raw, j, i);
            }

            html += `</td><td class="cc" ty="4" li="${i}">` + why[data[i].cc[4]%why.length];    //why
            html += not(2, i);                          //wip

            return html
        }

        // cgm ccs
        if(type == 6) {
            html = ``;

            // believe
            for(var j in '12') {
                // null
                if(!(dc2[j][0][0]%bel.length) && j == 0) 
                    html += `<td style='border-left:5px solid lightgrey;' class="cc" ty="${j}" li="${i}" cgi="0">`;
                
                else if(!(dc2[j][0][0]%bel.length))
                    html += `<td style='border-right:5px solid lightgrey;' class="cc" ty="${j}" li="${i}" cgi="0">`;

                // j:cc slot, k:item index
                else {
                    // console.log("in ccs j", j);
                    for(var k = 0; k < dc2[j].length; k++) {
                        // bel
                        if(!k && j == 0) html += `<td style='text-align:center; border-left:5px solid lightgrey;'>
                            <span class="cc" ty="${j}" li="${i}" cgi="${k}">` + bel[dc2[j][k][0]%bel.length] + `</span>`;
                        else if(!k) html += `<td style='text-align:center; border-right:5px solid lightgrey;'>
                            <span class="cc" ty="${j}" li="${i}" cgi="${k}">` + bel[dc2[j][k][0]%bel.length] + `</span>`;
                        else html += `<span class="cc" ty="${j}" li="${i}" cgi="${k}">` +
                            bel[dc2[j][k][0]%bel.length] + `</span>`;

                        // != current event number and != 0 (shows referencing #)
                        if(dc2[j][k][1] != data[i].ty[3] && dc2[j][k][1]) {
                            html += `<span class="edits" ty="5" ct="${j}" li="${i}" cgi="${k}"> ` + dc2[j][k][1] + `</span>`
                        }

                        // hightlingt then shows referencing number(ty3)
                        else if(d.ty[2]%2 || !hrefer) html += `<span class="edits" ty="5" ct ="${j}" li="${i}" cgi="${k}"> ` + 
                            d.ty[3] + `</span>`
                        
                        if(d.ty[2]%2) {
                            if(k) html += `<span class="add" ty="8" ct ="${j}" li="${i}" cgi="${k}"> -</span>`
                            else html += `<span class="add" ty="7" ct ="${j}" li="${i}"> +</span>`
                        }

                        html += `<br>`

                    }
                    html += `</td>`
                    // console.log("out");

                }
            }

            // CG
            for(var j in '34') {
                raw = ``
                j = parseInt(j) + 2;
                // null
                if(!(dc2[j][0][0]%cg.length)) raw += `<td class="cc" ty="${j}" li="${i}" cgi="0">`;
                // if(!(dc2[j][0][0]%cg.length) && j == 3) 
                //     raw += `<td style='border-right:5px solid black;' class="cc" ty="${j}" li="${i}" cgi="0">`;
                
                // else if(!(dc2[j][0][0]%cg.length)) raw += `<td class="cc" ty="${j}" li="${i}" cgi="0">`;

                else {
                    for(var k = 0; k < dc2[j].length; k++) {
                        // cg
                        if(!k) raw += `<td style='text-align:center;'>
                            <span class="cc" ty="${j}" li="${i}" cgi="${k}">` + cg[dc2[j][k][0]%cg.length] + `</span>`;
                        // if(!k && j == 3) raw += `<td style='text-align:center; border-right:5px solid black;'>
                        //     <span class="cc" ty="${j}" li="${i}" cgi="${k}">` + cg[dc2[j][k][0]%cg.length] + `</span>`;
                        // else if(!k) raw += `<td style='text-align:center;'>
                            // <span class="cc" ty="${j}" li="${i}" cgi="${k}">` + cg[dc2[j][k][0]%cg.length] + `</span>`;
                        else raw += `<span class="cc" ty="${j}" li="${i}" cgi="${k}">` +
                            cg[dc2[j][k][0]%cg.length] + `</span>`;

                        // != current event number and != 0 (shows referencing #)
                        if(dc2[j][k][1] != data[i].ty[3] && dc2[j][k][1]) {
                            raw += `<span class="edits" ty="5" ct="${j}" li="${i}" cgi="${k}"> ` + dc2[j][k][1] + `</span>`
                        }
                        // hightlingt then shows referencing number(ty3)
                        else if(d.ty[2]%2 || !hrefer) raw += `<span class="edits" ty="5" ct ="${j}" li="${i}" cgi="${k}"> ` + 
                            d.ty[3] + `</span>`
                        
                        if(d.ty[2]%2) {
                            if(k) raw += `<span class="add" ty="8" ct ="${j}" li="${i}" cgi="${k}"> -</span>`
                            else raw += `<span class="add" ty="7" ct ="${j}" li="${i}"> +</span>`
                        }
                        raw += `<br>`
                    }
                    // raw += `</td>`
                }

                // coloring cc
                html += color(2, raw, j, i) + `</td>`;
                // html += raw;
            }
            
            ww = 5
            html += `<td style='width:` + ww + `%' class="cc" ty="4" li="${i}">` + why[data[i].cc[4]%why.length];    //why
            html += not(2, i);                          //wip

            return html
        }
    }

    function color(type, v, a, b) {
        html = ``
        // entities
        if(!type) {
            for(var i = 0; i < v.length; i++) {
                k = v[i].indexOf('=')
                if(k > -1) w = v[i].substring(0, k);
                else w = v[i];
                // console.log("color:", w, k);
                
                if(data[b].e2.includes(w) && eja) html += `<span style='color:green'>(JA) </span>`;

                if(k > 0) 
                    html += `<span class="word" style='color:blue' ty="${a}" li="${b}" e="${v[i].substring(0, k)}">`
                        + v[i].substring(0, k) +`</span>` +
                    `<span class="word" ty="2" li="${b}" e="${v[i].substring(0, k)}">`+ v[i].substring(k)
                else html += `<span class="word" style='color:blue' ty="${a}" li="${b}" e="${v[i]}">`+ v[i]
                html += `</span><br>`
                // if(i < v.length-1) html += `\n`
            }
            html += `<span class="add" li="${b}" ty="6">+</span>`
        }
        else if(type == 1) {
            if(v.length) {
                // // console.log(v)
                // k = v[i].indexOf('JA')
                // j = v[i].indexOf('RT')
                // if(v)
                html += v;
                html = html.replace('JA', `<span style='color:green' ty="${a}" li="${b}">JA</span>`);
                html = html.replace('IN', `<span style='color:blue' ty="${a}" li="${b}">IN</span>`);
                html = html.replace('RT', `<span style='color:red' ty="${a}" li="${b}">RT</span>`);

                // html = html.replace('RT', `<span style='color:red'>RT</span>`);
                // console.log(html)
            }
            // return html
        }

        else {
            if(v.length) {

                html += v;
                html = html.replace('>JA', ` style='color:green'>JA`);
                html = html.replace('>IN', ` style='color:blue'>IN`);
                html = html.replace('>RT', ` style='color:red' >RT`);
            }
        }
        return html

    }

    function save() {
        var obj=data;
        let today = new Date().toISOString().replace('-', '').replace('-', '').slice(2, 8)
        var filename = did + '_' + nm + '_' + today;
        console.log(filename)

        //Start of saving method
        if(cgm) {
            var textToSave = max + ',' + eja + ',' + cgm + ',' + hrefer + '\n';
            for(var i in obj) {
                if(i < max) {
                    for(var j in obj[i]) {
                        // console.log(j, obj[i][j]);
                        if(j == 'cc2' || j == 'eve') {
                            for(var k in obj[i][j]) textToSave += obj[i][j][k] + '^';
                            textToSave = trim(textToSave, 1);
                        }
                        else textToSave += obj[i][j] + '\t';
                    }
                }
                textToSave = trim(textToSave, 2);
            }
        }
        
        // transition mode
        else {
            var textToSave = max + '\n';
            for(var i in obj) {
                if(i < max) {
                    for(var j in obj[i]) { textToSave += obj[i][j] + '\n'; }
                }
            }
        }

        console.log(textToSave)

        //Saving string to file using html clicking trick
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
        // console.log(hiddenElement.href)
        hiddenElement.target = '_blank';
        hiddenElement.download = filename;
        hiddenElement.click();
    }

    function audio_clips(i) { 
        if(!i) txt = 'Intro';
        else txt = 'Clip #' + i;      
        return `<tr><td colspan="1" id="ctext">` + txt + `</td><td colspan="20"><audio id="player" preload="none"
                controls src=` + `"/static/` + did + `_` + i + `.mp3"` + `>
                Your browser does not support the <code>audio</code> element.</audio></td></tr>`
    }

</script>